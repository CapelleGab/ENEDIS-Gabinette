"""
Module de gestion des logs structur√©s pour PMT Analytics.
Permet d'organiser les logs par cat√©gorie d'employ√©s et par agence.

author : CAPELLE Gabin
"""

import pandas as pd

class StructuredLogger:
    """
    Gestionnaire de logs structur√©s qui organise les donn√©es par:
    - Type d'employ√© (ASTREINTE, TIP, 3x8, Autres)
    - DR (Direction R√©gionale: DR PARIS, DIR NATIONALE, etc.)
    - Global (Toutes agences confondues)
    """

    def __init__(self, log_manager=None):
        """
        Initialise le logger structur√©.

        Args:
            log_manager: LogManager existant pour afficher les logs dans l'UI (facultatif)
        """
        self.log_manager = log_manager
        self.logs = {
            "Employ√©s": {
                "ASTREINTE": [],
                "TIP": [],
                "3x8": [],
                "Autres": []
            },
            "DR": {},
            "Global": []
        }

    def log(self, message, category="Global", subcategory=None):
        """
        Ajoute un message de log dans la cat√©gorie sp√©cifi√©e.

        Args:
            message (str): Message √† logger
            category (str): Cat√©gorie principale ("Employ√©s", "DR", "Global")
            subcategory (str, optional): Sous-cat√©gorie (ex: "ASTREINTE", "DR PARIS")
        """
        if category == "Global":
            self.logs["Global"].append(message)
        elif category in self.logs:
            if category == "DR":
                # Pour les DR, cr√©er la sous-cat√©gorie si elle n'existe pas
                if subcategory not in self.logs[category]:
                    self.logs[category][subcategory] = []
                self.logs[category][subcategory].append(message)
            elif subcategory in self.logs[category]:
                self.logs[category][subcategory].append(message)

        # Afficher √©galement dans le log_manager si disponible
        if self.log_manager:
            self.log_manager.log_message(message)

    def log_employee_stats(self, stats_df, category, df_type="stats"):
        """
        Ajoute des statistiques d'employ√©s dans la cat√©gorie appropri√©e.

        Args:
            stats_df (pd.DataFrame): DataFrame de statistiques
            category (str): Cat√©gorie d'employ√©s ("ASTREINTE", "TIP", "3x8", "Autres")
            df_type (str): Type de donn√©es ("stats" ou "moyennes")
        """
        if stats_df is None or stats_df.empty:
            self.log(f"Aucune donn√©e disponible pour {category}", "Employ√©s", category)
            return

        # Nombre d'employ√©s
        nb_employes = len(stats_df)
        self.log(f"Nombre d'employ√©s {category}: {nb_employes}", "Employ√©s", category)

        # Statistiques g√©n√©rales selon le type de donn√©es
        if df_type == "stats":
            if 'Total_Heures_Travaill√©es' in stats_df.columns:
                moy_heures = stats_df['Total_Heures_Travaill√©es'].mean()
                self.log(f"Moyenne d'heures travaill√©es {category}: {moy_heures:.1f}h", "Employ√©s", category)

            if 'Pr√©sence_%_365j' in stats_df.columns:
                moy_presence = stats_df['Pr√©sence_%_365j'].mean()
                self.log(f"Taux de pr√©sence moyen {category}: {moy_presence:.1f}%", "Employ√©s", category)

            if 'Heures_Supp' in stats_df.columns:
                total_hs = stats_df['Heures_Supp'].sum()
                moy_hs = stats_df['Heures_Supp'].mean() if nb_employes > 0 else 0
                self.log(f"Total heures suppl√©mentaires {category}: {total_hs:.1f}h (moy: {moy_hs:.1f}h)", "Employ√©s", category)

            if 'Nb_P√©riodes_Arr√™ts' in stats_df.columns:
                total_periodes = stats_df['Nb_P√©riodes_Arr√™ts'].sum()
                self.log(f"Total p√©riodes d'arr√™ts maladie {category}: {total_periodes}", "Employ√©s", category)

            if 'Nb_Jours_Arr√™ts_41' in stats_df.columns and 'Nb_Jours_Arr√™ts_5H' in stats_df.columns:
                total_jours_41 = stats_df['Nb_Jours_Arr√™ts_41'].sum()
                total_jours_5h = stats_df['Nb_Jours_Arr√™ts_5H'].sum()
                self.log(f"Total jours arr√™ts maladie {category}: 41={total_jours_41}, 5H={total_jours_5h}", "Employ√©s", category)

            # Statistiques sp√©cifiques 3x8
            if category == "3x8":
                if 'Postes_Matin' in stats_df.columns:
                    total_matin = stats_df['Postes_Matin'].sum()
                    self.log(f"Total postes matin {category}: {total_matin}", "Employ√©s", category)

                if 'Postes_Apres_Midi' in stats_df.columns:
                    total_apres_midi = stats_df['Postes_Apres_Midi'].sum()
                    self.log(f"Total postes apr√®s-midi {category}: {total_apres_midi}", "Employ√©s", category)

                if 'Postes_Nuit' in stats_df.columns:
                    total_nuit = stats_df['Postes_Nuit'].sum()
                    self.log(f"Total postes nuit {category}: {total_nuit}", "Employ√©s", category)

    def log_dr_stats(self, stats_df, employee_type, dr_column="UM (Lib)"):
        """
        Ajoute des statistiques par Direction R√©gionale (DR) en filtrant par la colonne UM.

        Args:
            stats_df (pd.DataFrame): DataFrame de statistiques
            employee_type (str): Type d'employ√©s ("ASTREINTE", "TIP", "3x8", "Autres")
            dr_column (str): Nom de la colonne contenant la Direction R√©gionale
        """
        if stats_df is None or stats_df.empty:
            self.log(f"Aucune donn√©e pour {employee_type}", "Global")
            return

        if dr_column not in stats_df.columns:
            self.log(f"Colonne '{dr_column}' non trouv√©e pour {employee_type}. Colonnes disponibles: {', '.join(stats_df.columns)}", "Global")
            return

        # Identifier toutes les DR pr√©sentes dans le DataFrame
        drs = stats_df[dr_column].dropna().unique()

        if len(drs) == 0:
            self.log(f"Aucune Direction R√©gionale trouv√©e pour {employee_type}", "Global")
            return

        # Message de d√©bogage
        self.log(f"Directions R√©gionales trouv√©es pour {employee_type}: {len(drs)}", "Global")

        # Mettre DR PARIS en premier dans la liste si elle existe
        if "DR PARIS" in drs:
            # R√©organiser pour que DR PARIS soit la premi√®re
            drs_list = list(drs)
            drs_list.remove("DR PARIS")
            drs_list.insert(0, "DR PARIS")
            drs = drs_list

        for dr in drs:
            if pd.isna(dr) or dr == "":
                continue

            # Filtrer les donn√©es pour cette DR
            dr_df = stats_df[stats_df[dr_column] == dr]

            if dr_df.empty:
                continue

            # Nombre d'employ√©s
            nb_employes = len(dr_df)

            # Marquer DR PARIS avec un indicateur sp√©cial
            dr_prefix = "üîç " if dr == "DR PARIS" else ""
            self.log(f"{dr_prefix}Nombre d'employ√©s {employee_type}: {nb_employes}", "DR", dr)

            # Statistiques g√©n√©rales
            if 'Total_Heures_Travaill√©es' in dr_df.columns:
                moy_heures = dr_df['Total_Heures_Travaill√©es'].mean()
                self.log(f"{dr_prefix}Moyenne d'heures travaill√©es {employee_type}: {moy_heures:.1f}h", "DR", dr)

            if 'Pr√©sence_%_365j' in dr_df.columns:
                moy_presence = dr_df['Pr√©sence_%_365j'].mean()
                self.log(f"{dr_prefix}Taux de pr√©sence moyen {employee_type}: {moy_presence:.1f}%", "DR", dr)

            if 'Heures_Supp' in dr_df.columns:
                total_hs = dr_df['Heures_Supp'].sum()
                moy_hs = dr_df['Heures_Supp'].mean() if nb_employes > 0 else 0
                self.log(f"{dr_prefix}Total heures suppl√©mentaires {employee_type}: {total_hs:.1f}h (moy: {moy_hs:.1f}h)", "DR", dr)

            if 'Nb_P√©riodes_Arr√™ts' in dr_df.columns:
                total_periodes = dr_df['Nb_P√©riodes_Arr√™ts'].sum()
                self.log(f"{dr_prefix}Total p√©riodes d'arr√™ts maladie {employee_type}: {total_periodes}", "DR", dr)

            if 'Nb_Jours_Arr√™ts_41' in dr_df.columns and 'Nb_Jours_Arr√™ts_5H' in dr_df.columns:
                total_jours_41 = dr_df['Nb_Jours_Arr√™ts_41'].sum()
                total_jours_5h = dr_df['Nb_Jours_Arr√™ts_5H'].sum()
                self.log(f"{dr_prefix}Total jours arr√™ts maladie {employee_type}: 41={total_jours_41}, 5H={total_jours_5h}", "DR", dr)

    def format_summary(self):
        """Format les logs en un r√©sum√© structur√©."""
        summary = []

        # En-t√™te
        summary.extend([
            "="*80,
            "R√âSUM√â DES STATISTIQUES PAR CAT√âGORIE",
            "="*80,
            ""
        ])

        # ASTREINTE
        summary.extend([
            "-"*80,
            "EMPLOY√âS ASTREINTE",
            "-"*80,
            ""
        ])

        # Ajouter les logs des employ√©s ASTREINTE
        astreinte_logs = self.logs["Employ√©s"].get("ASTREINTE", [])
        if not astreinte_logs:
            summary.append("‚Ä¢ Aucune donn√©e disponible pour les employ√©s ASTREINTE")
            summary.append("")
        else:
            for log in astreinte_logs:
                summary.append(f"‚Ä¢ {log}")
            summary.append("")

        # TIP
        summary.extend([
            "-"*80,
            "EMPLOY√âS TIP (HORS ASTREINTE)",
            "-"*80,
            ""
        ])

        # Ajouter les logs des employ√©s TIP
        tip_logs = self.logs["Employ√©s"].get("TIP", [])
        if not tip_logs:
            summary.append("‚Ä¢ Aucune donn√©e disponible pour les employ√©s TIP")
            summary.append("")
        else:
            for log in tip_logs:
                summary.append(f"‚Ä¢ {log}")
            summary.append("")

        # 3x8
        summary.extend([
            "-"*80,
            "EMPLOY√âS 3x8",
            "-"*80,
            ""
        ])

        # Ajouter les logs des employ√©s 3x8
        x8_logs = self.logs["Employ√©s"].get("3x8", [])
        if not x8_logs:
            summary.append("‚Ä¢ Aucune donn√©e disponible pour les employ√©s 3x8")
            summary.append("")
        else:
            for log in x8_logs:
                summary.append(f"‚Ä¢ {log}")
            summary.append("")

        # AUTRES
        summary.extend([
            "-"*80,
            "AUTRES EMPLOY√âS",
            "-"*80,
            ""
        ])

        # Ajouter les logs des employ√©s Autres
        autres_logs = self.logs["Employ√©s"].get("Autres", [])
        if not autres_logs:
            summary.append("‚Ä¢ Aucune donn√©e disponible pour les autres employ√©s")
            summary.append("")
        else:
            for log in autres_logs:
                summary.append(f"‚Ä¢ {log}")
            summary.append("")

        # Statistiques par DR
        if self.logs["DR"]:
            # V√©rifier si DR PARIS existe
            if "DR PARIS" in self.logs["DR"]:
                summary.extend([
                    "-"*80,
                    "STATISTIQUES PAR DIRECTION R√âGIONALE",
                    "-"*80,
                    ""
                ])

                # Afficher uniquement DR PARIS
                dr_paris_logs = self.logs["DR"]["DR PARIS"]
                summary.append("‚Ä¢ üîç DR PARIS (Direction prioritaire)")
                for log in dr_paris_logs:
                    summary.append(f"  - {log}")
                summary.append("")

        # Section Global
        summary.extend([
            "-"*80,
            "GLOBAL",
            "-"*80,
            ""
        ])

        # Ajouter les logs globaux
        for log in self.logs["Global"]:
            summary.append(f"‚Ä¢ {log}")

        summary.append("")
        summary.append("="*80)

        return "\n".join(summary)

    def clear(self):
        """Efface tous les logs."""
        for category in self.logs:
            if isinstance(self.logs[category], list):
                self.logs[category] = []
            else:
                for subcategory in self.logs[category]:
                    self.logs[category][subcategory] = []

        # R√©initialiser le dictionnaire DR qui peut contenir des cl√©s dynamiques
        self.logs["DR"] = {}
